<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>HairBook Setup</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { margin-top: 0; font-size: 28px; }
        h2 { font-size: 18px; margin: 0 0 12px 0; }
        .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        label { display: block; margin: 8px 0 4px; font-size: 13px; color: #94a3b8; font-weight: 500; }
        input, textarea, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #1f2937; background: #0b1220; color: #e2e8f0; font-size: 14px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #2563eb; }
        textarea { min-height: 120px; resize: vertical; font-family: 'Courier New', monospace; }
        button { margin-top: 10px; padding: 12px 20px; border: none; border-radius: 8px; background: #2563eb; color: white; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        button:hover:not(:disabled) { background: #1d4ed8; transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .row { display: flex; gap: 12px; }
        .row > div { flex: 1; }
        .log-container { background: #0b1220; border: 1px solid #1f2937; border-radius: 8px; padding: 0; overflow: hidden; max-height: 400px; }
        .log-header { background: #1f2937; padding: 10px 16px; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: center; }
        .log-header h3 { margin: 0; font-size: 14px; font-weight: 600; }
        .log-clear { background: #dc2626; padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: none; color: white; }
        .log { padding: 16px; min-height: 200px; max-height: 320px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; }
        .log-entry { margin-bottom: 8px; display: flex; align-items: flex-start; }
        .log-icon { margin-right: 8px; font-size: 16px; flex-shrink: 0; }
        .log-time { color: #64748b; margin-right: 8px; font-size: 11px; flex-shrink: 0; }
        .log-message { flex: 1; }
        .log-entry.success { color: #22c55e; }
        .log-entry.error { color: #ef4444; }
        .log-entry.warning { color: #f59e0b; }
        .log-entry.info { color: #cbd5e1; }
        .pill { display: inline-block; padding: 4px 10px; border-radius: 12px; background: #1f2937; margin-right: 8px; font-size: 11px; color: #cbd5e1; text-transform: uppercase; font-weight: 600; }
        .progress-bar { width: 100%; height: 4px; background: #1f2937; border-radius: 2px; overflow: hidden; margin-top: 12px; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #3b82f6); transition: width 0.3s; }
        .btn-danger { background: #dc2626 !important; }
        .btn-danger:hover:not(:disabled) { background: #b91c1c !important; }
    </style>
</head>
<body>
    <h1>HairBook Setup Wizard</h1>
    <p class="pill">DB: SQLite / MySQL</p><p class="pill">Kroky: test ‚Üí vytvo≈ôit tabulky ‚Üí migrace ‚Üí wipe</p>

    <div class="card">
        <h2>1) P≈ôipojen√≠ k DB a ulo≈æen√≠ .env</h2>
        <div class="row">
            <div>
                <label>Typ datab√°ze</label>
                <select id="dbType">
                    <option value="sqlite">SQLite (v√Ωchoz√≠)</option>
                    <option value="mysql">MySQL / MariaDB</option>
                </select>
            </div>
            <div>
                <label>Token (WIZARD_TOKEN, voliteln√©)</label>
                <input id="token" placeholder="pokud je nastaven WIZARD_TOKEN">
            </div>
        </div>
        <div id="mysqlFields">
            <div class="row">
                <div>
                    <label>Host</label>
                    <input id="dbHost" value="localhost">
                </div>
                <div>
                    <label>DB n√°zev</label>
                    <input id="dbName" value="hairbook">
                </div>
            </div>
            <div class="row">
                <div>
                    <label>U≈æivatel</label>
                    <input id="dbUser" value="root">
                </div>
                <div>
                    <label>Heslo</label>
                    <input id="dbPass" type="password" value="">
                </div>
                <div>
                    <label>Charset</label>
                    <input id="dbCharset" value="utf8mb4">
                </div>
            </div>
            <div>
                <label>Nov√Ω WIZARD_TOKEN (ulo≈æ√≠ se do .env, voliteln√©)</label>
                <input id="wizardToken" placeholder="nap≈ô. silne-heslo">
            </div>
        </div>
        <button onclick="testConnection()">Otestovat a ulo≈æit .env</button>
    </div>

    <div class="card">
        <h2>2) Vytvo≈ôit tabulky</h2>
        <p>Spust√≠ <code>api/init-db.php</code> podle nastaven√≠ z .env.</p>
        <button onclick="runInit()">Vytvo≈ôit sch√©ma</button>
    </div>

    <div class="card">
        <h2>3) Migrace dat (JSON z localStorage)</h2>
        <textarea id="migrateInput" placeholder='Vlo≈æ JSON s daty (clients, products, categories, services, visits, purchases...)'></textarea>
        <button onclick="runMigrate()">Importovat</button>
    </div>

    <div class="card">
        <h2>4) Vymazat v≈°echna data</h2>
        <p>Vol√° <code>reset-db.php</code> a sma≈æe obsah v≈°ech tabulek. Vy≈æaduje potvrzen√≠ a (pokud je nastaven) WIZARD_TOKEN.</p>
        <button class="btn-danger" onclick="runReset()">Smazat v≈°e</button>
    </div>

    <div class="card">
        <h2>5) Kompletn√≠ z√°loha / obnova (v≈°echny tabulky)</h2>
        <p>Export/Import p≈ôes <code>backup.php</code>. Vy≈æaduje token, pokud je nastaven <code>WIZARD_TOKEN</code>.</p>
        <div class="row">
            <div>
                <button onclick="downloadBackup()">St√°hnout z√°lohu (JSON)</button>
            </div>
            <div>
                <label>Nahr√°t z√°lohu (JSON)</label>
                <input type="file" id="backupFile" accept=".json" />
                <button onclick="uploadBackup()">Obnovit ze z√°lohy</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="log-container">
            <div class="log-header">
                <h3>üìã Log operac√≠</h3>
                <button class="log-clear" onclick="clearLog()">Vymazat</button>
            </div>
            <div id="log" class="log"></div>
        </div>
        <div id="progressBar" class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
    </div>

    <script>
        const logEl = document.getElementById('log');
        const dbTypeEl = document.getElementById('dbType');
        const mysqlFields = document.getElementById('mysqlFields');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        function formatTime() {
            const now = new Date();
            return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
        }

        function log(msg, type = 'info') {
            const icons = {
                error: '‚ùå',
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <span class="log-icon">${icons[type]}</span>
                <span class="log-time">${formatTime()}</span>
                <span class="log-message">${msg}</span>
            `;
            logEl.insertBefore(entry, logEl.firstChild);
        }

        function clearLog() {
            logEl.innerHTML = '';
            log('Log vymaz√°n', 'info');
        }

        function showProgress(show = true) {
            progressBar.style.display = show ? 'block' : 'none';
            if (!show) progressFill.style.width = '0%';
        }

        function setProgress(percent) {
            progressFill.style.width = `${Math.min(100, Math.max(0, percent))}%`;
        }

        function headersWithToken() {
            const token = document.getElementById('token').value.trim();
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['X-Setup-Token'] = token;
            return headers;
        }

        dbTypeEl.addEventListener('change', () => {
            mysqlFields.style.display = dbTypeEl.value === 'mysql' ? 'block' : 'none';
        });
        mysqlFields.style.display = dbTypeEl.value === 'mysql' ? 'block' : 'none';

        async function testConnection() {
            log('Testov√°n√≠ p≈ôipojen√≠ k datab√°zi...', 'info');
            showProgress(true);
            setProgress(30);
            
            const payload = {
                type: dbTypeEl.value,
                host: document.getElementById('dbHost').value,
                name: document.getElementById('dbName').value,
                user: document.getElementById('dbUser').value,
                pass: document.getElementById('dbPass').value,
                charset: document.getElementById('dbCharset').value
            };
            const newToken = document.getElementById('wizardToken').value.trim();
            if (newToken) payload.wizardToken = newToken;
            
            try {
                setProgress(50);
                const res = await fetch('setup-test.php', {
                    method: 'POST',
                    headers: headersWithToken(),
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                setProgress(90);
                
                if (!res.ok || data.error) throw new Error(data.error || res.statusText);
                
                setProgress(100);
                log(`P≈ôipojen√≠ √∫spƒõ≈°n√©! DB typ: ${data.db.type}`, 'success');
                log(`Konfigurace ulo≈æena do .env`, 'success');
                if (data.db.type === 'mysql') {
                    log(`MySQL: ${data.db.user}@${data.db.host}/${data.db.name}`, 'info');
                }
                setTimeout(() => showProgress(false), 500);
            } catch (err) {
                setProgress(0);
                showProgress(false);
                log(`Test p≈ôipojen√≠ selhal: ${err.message}`, 'error');
            }
        }

        async function runInit() {
            log('Spou≈°t√≠m vytv√°≈ôen√≠ datab√°zov√©ho sch√©matu...', 'info');
            showProgress(true);
            setProgress(20);
            
            try {
                setProgress(40);
                const res = await fetch('init-db.php');
                const text = await res.text();
                setProgress(80);
                
                if (!res.ok) throw new Error(text || res.statusText);
                
                setProgress(100);
                
                // Parsov√°n√≠ v√Ωstupu
                const lines = text.trim().split('\n');
                lines.forEach(line => {
                    if (line.includes('‚úÖ')) {
                        log(line.replace('‚úÖ', '').trim(), 'success');
                    } else if (line.includes('‚ùå')) {
                        log(line.replace('‚ùå', '').trim(), 'error');
                    } else if (line) {
                        log(line, 'info');
                    }
                });
                
                if (!text.includes('‚ùå')) {
                    log('Datab√°zov√© sch√©ma √∫spƒõ≈°nƒõ vytvo≈ôeno', 'success');
                }
                
                setTimeout(() => showProgress(false), 500);
            } catch (err) {
                setProgress(0);
                showProgress(false);
                log(`Vytvo≈ôen√≠ sch√©matu selhalo: ${err.message}`, 'error');
            }
        }

        async function runMigrate() {
            const raw = document.getElementById('migrateInput').value.trim();
            if (!raw) return log('Pros√≠m vlo≈æte JSON data pro import', 'error');
            
            log('Validace JSON...', 'info');
            let parsed;
            try {
                parsed = JSON.parse(raw);
            } catch (e) {
                return log('Chyba v JSON form√°tu: ' + e.message, 'error');
            }
            
            log('Spou≈°t√≠m import dat...', 'info');
            showProgress(true);
            setProgress(30);
            
            try {
                setProgress(50);
                const res = await fetch('migrate.php', {
                    method: 'POST',
                    headers: headersWithToken(),
                    body: JSON.stringify(parsed)
                });
                const data = await res.json();
                setProgress(90);
                
                if (!res.ok || data.error) throw new Error(data.error || res.statusText);
                
                setProgress(100);
                log('Import dat dokonƒçen', 'success');
                
                // Detail importu
                if (data.stats) {
                    Object.entries(data.stats).forEach(([table, count]) => {
                        if (count > 0) {
                            log(`  ${table}: ${count} z√°znam≈Ø`, 'info');
                        }
                    });
                }
                
                setTimeout(() => showProgress(false), 500);
            } catch (err) {
                setProgress(0);
                showProgress(false);
                log(`Import selhal: ${err.message}`, 'error');
            }
        }

        async function runReset() {
            if (!confirm('‚ö†Ô∏è VAROV√ÅN√ç: Tato akce sma≈æe v≈°echna data z datab√°ze!\n\nOpravdu chcete pokraƒçovat?')) return;
            
            log('Maz√°n√≠ v≈°ech dat z datab√°ze...', 'warning');
            showProgress(true);
            setProgress(30);
            
            const payload = { confirm: 'DELETE_ALL' };
            try {
                setProgress(60);
                const res = await fetch('reset-db.php', {
                    method: 'POST',
                    headers: headersWithToken(),
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                setProgress(90);
                
                if (!res.ok || data.error) throw new Error(data.error || res.statusText);
                
                setProgress(100);
                log('V≈°echna data √∫spƒõ≈°nƒõ vymaz√°na', 'success');
                setTimeout(() => showProgress(false), 500);
            } catch (err) {
                setProgress(0);
                showProgress(false);
                log(`Reset selhal: ${err.message}`, 'error');
            }
        }

        async function downloadBackup() {
            log('Stahov√°n√≠ z√°lohy...', 'info');
            showProgress(true);
            setProgress(30);
            
            try {
                setProgress(60);
                const res = await fetch('backup.php', {
                    headers: headersWithToken()
                });
                const data = await res.json();
                setProgress(80);
                
                if (!res.ok || data.error) throw new Error(data.error || res.statusText);
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const filename = `hairbook-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setProgress(100);
                log(`Z√°loha √∫spƒõ≈°nƒõ sta≈æena: ${filename}`, 'success');
                
                // Statistiky
                if (data.data) {
                    Object.entries(data.data).forEach(([table, records]) => {
                        if (records && records.length > 0) {
                            log(`  ${table}: ${records.length} z√°znam≈Ø`, 'info');
                        }
                    });
                }
                
                setTimeout(() => showProgress(false), 500);
            } catch (err) {
                setProgress(0);
                showProgress(false);
                log('Sta≈æen√≠ z√°lohy selhalo: ' + err.message, 'error');
            }
        }

        async function uploadBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            if (!file) return log('Pros√≠m vyberte soubor z√°lohy', 'error');
            
            log(`Naƒç√≠t√°n√≠ souboru: ${file.name}...`, 'info');
            const text = await file.text();
            
            let parsed;
            try {
                parsed = JSON.parse(text);
            } catch (e) {
                return log('Chyba v JSON form√°tu: ' + e.message, 'error');
            }
            
            if (!parsed.data) {
                return log('Neplatn√° z√°loha - chyb√≠ sekce "data"', 'error');
            }
            
            if (!confirm('‚ö†Ô∏è VAROV√ÅN√ç: Obnoven√≠ ze z√°lohy p≈ôep√≠≈°e v≈°echna aktu√°ln√≠ data!\n\nChcete pokraƒçovat?')) return;
            
            log('Spou≈°t√≠m obnovu ze z√°lohy...', 'info');
            showProgress(true);
            setProgress(30);
            
            try {
                setProgress(60);
                const res = await fetch('backup.php', {
                    method: 'POST',
                    headers: headersWithToken(),
                    body: JSON.stringify(parsed)
                });
                const data = await res.json();
                setProgress(90);
                
                if (!res.ok || data.error) throw new Error(data.error || res.statusText);
                
                setProgress(100);
                log('Obnova ze z√°lohy dokonƒçena', 'success');
                
                // Detail obnovy
                if (data.counts) {
                    Object.entries(data.counts).forEach(([table, count]) => {
                        if (count > 0) {
                            log(`  ${table}: ${count} z√°znam≈Ø obnoveno`, 'info');
                        }
                    });
                }
                
                setTimeout(() => showProgress(false), 500);
            } catch (err) {
                setProgress(0);
                showProgress(false);
                log('Obnova selhala: ' + err.message, 'error');
            }
        }
    </script>
</body>
</html>
